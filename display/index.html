<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>Room Availability</title>
</head>
<body>
    <div id="rooms-container">
    </div>
    <script>
        const dayDict = {0: "M", 1: "T", 2: "W", 3: "R", 4: "F"};
        function isValidTime(schedule, hour, minute, cellDay, suffix) {
            let classHours = schedule[cellDay];
            let currentDate = new Date();  
            let currentTime = new Date(currentDate.getTime());
            
            // Adjust for 24 hour time
            if (suffix === "PM" && hour !== 12) {  
                hour += 12;
            } 
            else if (suffix === "AM" && hour === 12) {  
                hour = 0;  
            }

            currentTime.setHours(hour);
            currentTime.setMinutes(minute);
            currentTime.setSeconds(0);  

            for (const classTimes of classHours) {
                let [start, end] = classTimes;
                
                let classStart = new Date(currentDate.getTime());
                let classEnd = new Date(currentDate.getTime());

                let [startHour, startMinute] = start.split(":").map(Number);
                let [endHour, endMinute] = end.split(":").map(Number);

                classStart.setHours(startHour);
                classStart.setMinutes(startMinute);
                classStart.setSeconds(0);

                classEnd.setHours(endHour);
                classEnd.setMinutes(endMinute);
                classEnd.setSeconds(0);

                if (currentTime >= classStart && currentTime <= classEnd) {
                    return false;
                }
            }

            return true;
        }
        const roomContainer = document.getElementById('rooms-container');
        fetch('../schedules/fall.json')
            .then(response => response.json())
            .then(data => {
                for (const room of Object.entries(data.Rooms)){
                    
                    // initialize elements and properties
                    const roomDiv = document.createElement('div');
                    const scheduleDiv = document.createElement('div');
                    scheduleDiv.style.display = "none";
                    const roomName = document.createElement('h2');
                    const timeTable = document.createElement('table');
                    roomDiv.className = "roomDiv";
                    scheduleDiv.className = "scheduleDiv";
                    
                    // Create time table headers
                    const mondayHeader = document.createElement('th')
                    const tuesdayHeader = document.createElement('th')
                    const wednesdayHeader = document.createElement('th')
                    const thursdayHeader = document.createElement('th')
                    const fridayHeader = document.createElement('th')
                    const timeHeader = document.createElement('th');
                    const headerRow = document.createElement('tr');
                    mondayHeader.innerText = "Monday";
                    tuesdayHeader.innerText = "Tuesday";
                    wednesdayHeader.innerText = "Wednesday";
                    thursdayHeader.innerText = "Thursday";
                    fridayHeader.innerText = "Friday";
                    timeHeader.innerText = "Time";
                    headerRow.appendChild(timeHeader);
                    headerRow.appendChild(mondayHeader)
                    headerRow.appendChild(tuesdayHeader)
                    headerRow.appendChild(wednesdayHeader)
                    headerRow.appendChild(thursdayHeader)
                    headerRow.appendChild(fridayHeader)
                    timeTable.appendChild(headerRow);

                    let suffix = "AM";
                    let hour = 12;
                    let minutes = 0;

                    // Create the rest of the table
                    for (var i = 0; i < 144; i++) {
                        let row = document.createElement('tr');
                        let timeCell = document.createElement('td');
                        let formattedHour = hour === 0 ? 12 : hour;  
                        let formattedMinutes = minutes < 10 ? "0" + minutes : minutes;  // Add leading zero for single digits
                        timeCell.innerText = `${formattedHour}:${formattedMinutes} ${suffix}`;
                        row.appendChild(timeCell);
                        
                        // Populate rows
                        for (let j = 0; j < 5; j++) {
                            let emptyCell = document.createElement('td');
                            let cellDay = dayDict[j];
                            let valid = isValidTime(room[1], Number(hour), Number(minutes), cellDay, suffix);
                            valid ? emptyCell.style.backgroundColor = "green" : emptyCell.style.backgroundColor = "red";
                            row.appendChild(emptyCell);
                        }
                        
                        timeTable.appendChild(row);
                        
                        // Time logic
                        minutes += 10;
                        if (minutes === 60) {
                            minutes = 0;
                            hour++;
                        }
                        if (hour === 12 && suffix === "AM" && i > 40) {
                            suffix = "PM";
                        } 
                        else if (hour === 13) {
                            hour = 1;  
                        }
                    }                    
                    
                    // Make room divs collapsible
                    roomName.addEventListener("click", function(){
                        var content = scheduleDiv;
                        if (content.style.display === "none"){
                            content.style.display = "block";
                        }
                        else{
                            content.style.display = "none";
                        }
                    });
                    
                    roomName.innerText = room[0];
                    scheduleDiv.appendChild(timeTable);
                    roomDiv.appendChild(roomName);
                    roomDiv.appendChild(scheduleDiv);
                    roomContainer.appendChild(roomDiv);
                }
            })
            .catch(error => {
                console.error('Error loading rooms:', error);
            });        
    </script>
</body>
</html>